<!-- Page Header -->
<div class="mb-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Crear Nueva Tarea</h1>
  <p class="text-gray-600">Registre una nueva asignaci√≥n para las divisiones del CDCE</p>
</div>

<!-- Alerts -->
<% if (error) { %>
  <div class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg flex items-start gap-3 animate-fade-in">
    <%- include('../partials/icon', { name: 'x-circle', class: 'h-5 w-5 flex-shrink-0 mt-0.5' }) %>
    <span><%= error %></span>
  </div>
<% } %>

<% if (success) { %>
  <div class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg flex items-start gap-3 animate-fade-in">
    <%- include('../partials/icon', { name: 'check-circle', class: 'h-5 w-5 flex-shrink-0 mt-0.5' }) %>
    <span><%= success %></span>
  </div>
<% } %>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Form Card -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-lg shadow-md p-6">
      <form action="/tareas/crear" method="POST" class="space-y-6" id="formCrearTarea" novalidate>
        <!-- Nombre de la Tarea -->
        <div>
          <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
            Nombre de la Tarea <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <%- include('../partials/icon', { name: 'document-text', class: 'h-5 w-5 text-gray-400' }) %>
            </div>
            <input 
              type="text" 
              id="nombre" 
              name="nombre" 
              class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" 
              placeholder="Ej: Festival Deportivo Nacional"
              required
            >
          </div>
        </div>
        
        <!-- Divisi√≥n -->
        <div>
          <label for="divisionId" class="block text-sm font-medium text-gray-700 mb-2">
            Divisi√≥n o Coordinaci√≥n <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <%- include('../partials/icon', { name: 'building-office', class: 'h-5 w-5 text-gray-400' }) %>
            </div>
            <select 
              id="divisionId" 
              name="divisionId" 
              class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 appearance-none bg-white" 
              required
            >
              <option value="">Seleccione una divisi√≥n</option>
              <% divisiones.forEach(division => { %>
                <option value="<%= division.id %>"><%= division.nombre %></option>
              <% }); %>
            </select>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Checkbox Tarea Retroactiva -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <label class="flex items-start gap-3 cursor-pointer">
            <input 
              type="checkbox" 
              id="esRetroactiva" 
              name="esRetroactiva"
              class="mt-1 h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded"
            >
            <div class="flex-1">
              <span class="text-sm font-medium text-amber-900">
                Esta es una tarea retroactiva (fechas pasadas)
              </span>
              <p class="text-xs text-amber-700 mt-1">
                Marque esta opci√≥n si est√° registrando una tarea que ya ocurri√≥ en el pasado. 
                Esto le permitir√° ingresar fechas anteriores a hoy.
              </p>
            </div>
          </label>
        </div>
        
        <!-- Fechas y Horas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Fecha y Hora de Inicio -->
          <div>
            <label for="fechaInicio" class="block text-sm font-medium text-gray-700 mb-2">
              Fecha y Hora de Inicio <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <%- include('../partials/icon', { name: 'calendar', class: 'h-5 w-5 text-gray-400' }) %>
              </div>
              <input 
                type="datetime-local" 
                id="fechaInicio" 
                name="fechaInicio" 
                class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" 
                required
              >
            </div>
            <p class="mt-1 text-xs text-gray-500">Especifique fecha y hora exacta de inicio</p>
          </div>
          
          <!-- Fecha de Culminaci√≥n -->
          <div>
            <label for="fechaCulminacion" class="block text-sm font-medium text-gray-700 mb-2">
              Fecha de Culminaci√≥n <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <%- include('../partials/icon', { name: 'calendar', class: 'h-5 w-5 text-gray-400' }) %>
              </div>
              <input 
                type="datetime-local" 
                id="fechaCulminacion" 
                name="fechaCulminacion" 
                class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" 
                required
              >
            </div>
            <p class="mt-1 text-xs text-gray-500">Fecha l√≠mite de la tarea</p>
          </div>
        </div>
        
        <!-- Hora de Culminaci√≥n (condicional) -->
        <div id="horaContainer" class="hidden">
          <label for="horaCulminacion" class="block text-sm font-medium text-gray-700 mb-2">
            Hora de Culminaci√≥n <span id="horaRequired" class="text-red-500 hidden">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <%- include('../partials/icon', { name: 'clock', class: 'h-5 w-5 text-gray-400' }) %>
            </div>
            <input 
              type="time" 
              id="horaCulminacion" 
              name="horaCulminacion" 
              class="pl-10 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
            >
          </div>
          <p class="mt-1 text-xs text-gray-500" id="horaMensaje">
            Opcional para tareas de varios d√≠as (si no se especifica, finaliza a las 23:59:59)
          </p>
        </div>
        
        <!-- Mensaje de validaci√≥n -->
        <div id="validacionFechas" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg text-sm">
          <span id="mensajeValidacion"></span>
        </div>
        
        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="btnSubmit"
            class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
          >
            <%- include('../partials/icon', { name: 'plus', class: 'h-5 w-5' }) %>
            <span>Crear Tarea</span>
          </button>
          <a 
            href="/tareas/proceso" 
            class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200"
          >
            <%- include('../partials/icon', { name: 'x-mark', class: 'h-5 w-5' }) %>
            <span>Cancelar</span>
          </a>
        </div>
      </form>
      
      <script>
        // Prevenir validaci√≥n HTML5 nativa COMPLETAMENTE
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('formCrearTarea');
          const fechaInicio = document.getElementById('fechaInicio');
          const fechaCulminacion = document.getElementById('fechaCulminacion');
          
          // Remover TODOS los mensajes de validaci√≥n HTML5
          [fechaInicio, fechaCulminacion].forEach(input => {
            input.addEventListener('invalid', function(e) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }, true);
            
            // Limpiar cualquier mensaje de validaci√≥n personalizado
            input.setCustomValidity('');
          });
          
          // Interceptar el submit para manejar validaci√≥n manualmente
          form.addEventListener('submit', function(e) {
            // Limpiar mensajes de validaci√≥n
            fechaInicio.setCustomValidity('');
            fechaCulminacion.setCustomValidity('');
          }, true);
        });
        
        // Validaci√≥n de fechas en tiempo real
        const fechaInicio = document.getElementById('fechaInicio');
        const fechaCulminacion = document.getElementById('fechaCulminacion');
        const horaCulminacion = document.getElementById('horaCulminacion');
        const horaContainer = document.getElementById('horaContainer');
        const horaRequired = document.getElementById('horaRequired');
        const horaMensaje = document.getElementById('horaMensaje');
        const validacionDiv = document.getElementById('validacionFechas');
        const mensajeValidacion = document.getElementById('mensajeValidacion');
        const btnSubmit = document.getElementById('btnSubmit');
        const form = document.getElementById('formCrearTarea');
        const esRetroactiva = document.getElementById('esRetroactiva');
        
        // Manejar cambio de checkbox retroactiva
        esRetroactiva.addEventListener('change', function() {
          if (this.checked) {
            // Permitir fechas pasadas
            fechaInicio.removeAttribute('min');
            fechaCulminacion.removeAttribute('min');
            
            // Mostrar advertencia
            validacionDiv.classList.remove('hidden');
            validacionDiv.classList.remove('bg-green-50', 'border-green-200', 'text-green-800', 'bg-red-50', 'border-red-200', 'text-red-800');
            validacionDiv.classList.add('bg-amber-50', 'border-amber-200', 'text-amber-800');
            mensajeValidacion.textContent = '‚ö†Ô∏è Modo retroactivo activado: Puede ingresar fechas pasadas. La tarea se crear√° como "finalizada".';
          } else {
            // Restringir a fechas futuras
            const ahora = new Date();
            // Ajustar a zona horaria local sin conversi√≥n UTC
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            const ahoraStr = `${year}-${month}-${day}T${hours}:${minutes}`;
            fechaInicio.setAttribute('min', ahoraStr);
            
            validarFechas();
          }
        });
        
        function esMismoDia() {
          if (!fechaInicio.value || !fechaCulminacion.value) return false;
          
          const inicio = new Date(fechaInicio.value);
          // Extraer solo la fecha de culminaci√≥n (primeros 10 caracteres YYYY-MM-DD)
          const fechaCulmStr = fechaCulminacion.value.substring(0, 10);
          const fechaFin = new Date(fechaCulmStr);
          
          return inicio.toDateString() === fechaFin.toDateString();
        }
        
        function actualizarCampoHora() {
          const mismoDia = esMismoDia();
          
          if (fechaCulminacion.value) {
            // Si el campo de culminaci√≥n no tiene hora, agregar 23:59
            if (fechaCulminacion.value.length === 10) {
              // Solo tiene fecha (YYYY-MM-DD), agregar hora por defecto
              fechaCulminacion.value = fechaCulminacion.value + 'T23:59';
            }
            
            // Ocultar el campo de hora separado ya que ahora est√° integrado
            horaContainer.classList.add('hidden');
          }
          
          validarFechas();
        }
        
        function validarFechas() {
          if (!fechaInicio.value || !fechaCulminacion.value) {
            if (!esRetroactiva.checked) {
              validacionDiv.classList.add('hidden');
            }
            btnSubmit.disabled = false;
            return true;
          }
          
          const inicio = new Date(fechaInicio.value);
          const culminacion = new Date(fechaCulminacion.value);
          const ahora = new Date();
          
          // Extraer solo las fechas para comparar si es mismo d√≠a
          const inicioFecha = inicio.toDateString();
          const culminacionFecha = culminacion.toDateString();
          const mismoDia = inicioFecha === culminacionFecha;
          
          // Validar fechas seg√∫n si es retroactiva o no
          if (!esRetroactiva.checked) {
            if (mismoDia) {
              // Para mismo d√≠a: validar que la hora de culminaci√≥n sea futura
              if (culminacion <= ahora) {
                validacionDiv.classList.remove('hidden');
                validacionDiv.classList.remove('bg-yellow-50', 'border-yellow-200', 'text-yellow-800', 'bg-green-50', 'border-green-200', 'text-green-800', 'bg-amber-50', 'border-amber-200', 'text-amber-800');
                validacionDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                mensajeValidacion.textContent = '‚ùå La hora de culminaci√≥n debe ser futura. Por favor seleccione una hora posterior a la actual.';
                btnSubmit.disabled = true;
                return false;
              }
            } else {
              // Para varios d√≠as: validar que la fecha de inicio no sea pasada (solo fecha, no hora)
              const inicioSoloFecha = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate());
              const ahoraSoloFecha = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
              
              if (inicioSoloFecha < ahoraSoloFecha) {
                validacionDiv.classList.remove('hidden');
                validacionDiv.classList.remove('bg-yellow-50', 'border-yellow-200', 'text-yellow-800', 'bg-green-50', 'border-green-200', 'text-green-800', 'bg-amber-50', 'border-amber-200', 'text-amber-800');
                validacionDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                mensajeValidacion.textContent = '‚ùå La fecha de inicio no puede ser en el pasado. Active "Tarea Retroactiva" si desea crear una tarea con fechas pasadas.';
                btnSubmit.disabled = true;
                return false;
              }
            }
          }
          
          // Calcular diferencia en horas
          const diferenciaMs = culminacion - inicio;
          const diferenciaHoras = diferenciaMs / (1000 * 60 * 60);
          
          if (diferenciaHoras <= 0) {
            validacionDiv.classList.remove('hidden');
            validacionDiv.classList.remove('bg-yellow-50', 'border-yellow-200', 'text-yellow-800', 'bg-green-50', 'border-green-200', 'text-green-800', 'bg-amber-50', 'border-amber-200', 'text-amber-800');
            validacionDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
            mensajeValidacion.textContent = '‚ùå La fecha y hora de culminaci√≥n debe ser posterior a la de inicio';
            btnSubmit.disabled = true;
            return false;
          }
          
          if (mismoDia && diferenciaHoras < 1) {
            validacionDiv.classList.remove('hidden');
            validacionDiv.classList.remove('bg-green-50', 'border-green-200', 'text-green-800', 'bg-red-50', 'border-red-200', 'text-red-800', 'bg-amber-50', 'border-amber-200', 'text-amber-800');
            validacionDiv.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
            mensajeValidacion.textContent = '‚ö†Ô∏è La tarea debe tener al menos 1 hora de duraci√≥n (actualmente: ' + Math.round(diferenciaHoras * 60) + ' minutos)';
            btnSubmit.disabled = true;
            return false;
          }
          
          // Todo OK
          validacionDiv.classList.remove('hidden');
          validacionDiv.classList.remove('bg-yellow-50', 'border-yellow-200', 'text-yellow-800', 'bg-red-50', 'border-red-200', 'text-red-800', 'bg-amber-50', 'border-amber-200', 'text-amber-800');
          validacionDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
          
          const dias = Math.floor(diferenciaHoras / 24);
          const horas = Math.floor(diferenciaHoras % 24);
          const minutos = Math.floor((diferenciaHoras % 1) * 60);
          let duracion = '';
          if (dias > 0) duracion += dias + ' d√≠a' + (dias > 1 ? 's' : '') + ' ';
          if (horas > 0) duracion += horas + ' hora' + (horas > 1 ? 's' : '') + ' ';
          if (minutos > 0 && dias === 0) duracion += minutos + ' minuto' + (minutos > 1 ? 's' : '');
          
          // Extraer hora de culminaci√≥n del datetime-local
          const horaCulm = culminacion.toTimeString().substring(0, 5);
          const fechaCulm = culminacion.toLocaleDateString('es-ES');
          let mensaje = '‚úì Duraci√≥n: ' + duracion.trim() + ' | Finaliza: ' + fechaCulm + ' a las ' + horaCulm;
          
          if (esRetroactiva.checked) {
            mensaje += ' | üìã Tarea retroactiva - se crear√° como "finalizada"';
          }
          
          mensajeValidacion.textContent = mensaje;
          btnSubmit.disabled = false;
          return true;
        }
        
        fechaInicio.addEventListener('change', actualizarCampoHora);
        fechaCulminacion.addEventListener('change', actualizarCampoHora);
        horaCulminacion.addEventListener('change', validarFechas);
        
        form.addEventListener('submit', function(e) {
          if (!validarFechas()) {
            e.preventDefault();
            if (window.modal) {
              window.modal.notify({
                title: 'Error de Validaci√≥n',
                message: 'Por favor corrija los errores en las fechas antes de continuar.',
                type: 'error',
                buttonText: 'Entendido'
              });
            } else {
              alert('Por favor corrija los errores en las fechas antes de continuar');
            }
          }
        });
        
        // Inicializar restricci√≥n de fechas
        window.addEventListener('load', function() {
          if (!esRetroactiva.checked) {
            const ahora = new Date();
            // Ajustar a zona horaria local sin conversi√≥n UTC
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            const ahoraStr = `${year}-${month}-${day}T${hours}:${minutes}`;
            fechaInicio.setAttribute('min', ahoraStr);
          }
        });
      </script>
    </div>
  </div>
  
  <!-- Info Card -->
  <div class="lg:col-span-1">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 sticky top-6">
      <div class="flex items-start gap-3 mb-4">
        <%- include('../partials/icon', { name: 'information-circle', class: 'h-6 w-6 text-blue-600 flex-shrink-0' }) %>
        <h2 class="text-lg font-semibold text-blue-900">Informaci√≥n</h2>
      </div>
      <div class="space-y-3 text-sm text-blue-800">
        <p>
          Las tareas creadas se mostrar√°n autom√°ticamente en el m√≥dulo de <strong>"Tareas en Proceso"</strong>.
        </p>
        <p>
          Desde all√≠ podr√° registrar las entregas de los municipios y hacer seguimiento del cumplimiento.
        </p>
        <p>
          Las tareas cambiar√°n autom√°ticamente a estado <strong>"Finalizada"</strong> cuando se alcance la fecha y hora de culminaci√≥n.
        </p>
        <div class="border-t border-blue-200 pt-3 mt-3">
          <p class="font-semibold mb-2">‚è∞ Especificaci√≥n de Hora:</p>
          <ul class="list-disc list-inside space-y-1 text-xs">
            <li><strong>Mismo d√≠a:</strong> Hora de culminaci√≥n obligatoria (m√≠nimo 1 hora de duraci√≥n)</li>
            <li><strong>Varios d√≠as:</strong> Hora opcional (por defecto finaliza a las 23:59:59)</li>
          </ul>
        </div>
        <div class="border-t border-blue-200 pt-3 mt-3">
          <p class="font-semibold mb-2">üìã Tareas Retroactivas:</p>
          <ul class="list-disc list-inside space-y-1 text-xs">
            <li>Active el checkbox para crear tareas con fechas pasadas</li>
            <li>√ötil si olvid√≥ registrar una tarea a tiempo</li>
            <li>Se crear√°n como "finalizadas" si la fecha ya pas√≥</li>
            <li>Puede agregar entregas desde "Tareas Finalizadas"</li>
            <li>Se incluyen normalmente en evaluaciones y reportes</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
