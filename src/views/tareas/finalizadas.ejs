<!-- Page Header -->
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Tareas Finalizadas</h1>
  <p class="text-gray-600">Consulta el historial de tareas completadas con filtros avanzados</p>
</div>

<!-- Filters Card -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
  <div class="flex items-center gap-2 mb-4">
    <%- include('../partials/icon', { name: 'funnel', class: 'h-5 w-5 text-gray-700' }) %>
    <h2 class="text-lg font-semibold text-gray-900">Filtros de Búsqueda</h2>
  </div>
  
  <form action="/tareas/finalizadas" method="GET">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <!-- Fecha Inicio -->
      <div>
        <label for="fechaInicio" class="block text-sm font-medium text-gray-700 mb-1">
          Fecha Inicio
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <%- include('../partials/icon', { name: 'calendar', class: 'h-5 w-5 text-gray-400' }) %>
          </div>
          <input 
            type="date" 
            id="fechaInicio" 
            name="fechaInicio" 
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            value="<%= filtros.fechaInicio %>"
          >
        </div>
      </div>
      
      <!-- Fecha Fin -->
      <div>
        <label for="fechaFin" class="block text-sm font-medium text-gray-700 mb-1">
          Fecha Fin
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <%- include('../partials/icon', { name: 'calendar', class: 'h-5 w-5 text-gray-400' }) %>
          </div>
          <input 
            type="date" 
            id="fechaFin" 
            name="fechaFin" 
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            value="<%= filtros.fechaFin %>"
          >
        </div>
      </div>
      
      <!-- División -->
      <div>
        <label for="divisionId" class="block text-sm font-medium text-gray-700 mb-1">
          División
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <%- include('../partials/icon', { name: 'building-office', class: 'h-5 w-5 text-gray-400' }) %>
          </div>
          <select 
            id="divisionId" 
            name="divisionId" 
            class="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white"
          >
            <option value="">Todas las divisiones</option>
            <% divisiones.forEach(division => { %>
              <option value="<%= division.id %>" <%= filtros.divisionId == division.id ? 'selected' : '' %>>
                <%= division.nombre %>
              </option>
            <% }); %>
          </select>
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
      
      <!-- Nombre de Tarea -->
      <div>
        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">
          Nombre de Tarea
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <%- include('../partials/icon', { name: 'magnifying-glass', class: 'h-5 w-5 text-gray-400' }) %>
          </div>
          <input 
            type="text" 
            id="nombre" 
            name="nombre" 
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Buscar por nombre..."
            value="<%= filtros.nombre %>"
          >
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex gap-3">
      <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
        <%- include('../partials/icon', { name: 'magnifying-glass', class: 'h-5 w-5' }) %>
        Buscar
      </button>
      <a href="/tareas/finalizadas" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200">
        <%- include('../partials/icon', { name: 'x-mark', class: 'h-5 w-5' }) %>
        Limpiar
      </a>
    </div>
  </form>
</div>

<!-- Results Card -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <%- include('../partials/icon', { name: 'check-circle', class: 'h-5 w-5 text-gray-700' }) %>
      <h2 class="text-lg font-semibold text-gray-900">Resultados</h2>
    </div>
    <% if (tareas.length > 0) { %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
        <%= tareas.length %> tarea<%= tareas.length !== 1 ? 's' : '' %>
      </span>
    <% } %>
  </div>
  
  <% if (tareas.length === 0) { %>
    <div class="text-center py-12">
      <%- include('../partials/icon', { name: 'information-circle', class: 'h-12 w-12 text-gray-400 mx-auto mb-3' }) %>
      <p class="text-gray-600 mb-4">No se encontraron tareas finalizadas con los criterios seleccionados</p>
      <a href="/tareas/finalizadas" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
        <%- include('../partials/icon', { name: 'x-mark', class: 'h-5 w-5' }) %>
        Limpiar Filtros
      </a>
    </div>
  <% } else { %>
    <!-- Desktop Table -->
    <div class="hidden md:block overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gradient-to-r from-blue-50 to-blue-100">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              Nombre de la Tarea
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              División
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              Fecha de Inicio
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              Fecha de Culminación
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              Entregas
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% tareas.forEach(tarea => { %>
            <tr class="hover:bg-gray-50 transition-colors duration-150">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <%- include('../partials/icon', { name: 'document-text', class: 'h-5 w-5 text-gray-400' }) %>
                  <span class="text-sm font-medium text-gray-900"><%= tarea.nombre %></span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <%= tarea.division.nombre %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <%= new Date(tarea.fechaInicio).toLocaleDateString('es-ES') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                <%= new Date(tarea.fechaCulminacion).toLocaleDateString('es-ES') %>
              </td>
              <td class="px-6 py-4">
                <% if (tarea.entregas && tarea.entregas.length > 0) { %>
                  <details class="group">
                    <summary class="cursor-pointer list-none">
                      <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 hover:bg-green-200 transition-colors">
                        <%- include('../partials/icon', { name: 'check-circle', class: 'h-4 w-4' }) %>
                        <%= tarea.entregas.length %> entrega<%= tarea.entregas.length !== 1 ? 's' : '' %>
                      </span>
                    </summary>
                    <div class="mt-2 ml-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <ul class="space-y-1">
                        <% tarea.entregas.forEach(entrega => { %>
                          <li class="text-sm text-gray-700 flex items-center gap-2">
                            <%- include('../partials/icon', { name: 'map-pin', class: 'h-4 w-4 text-gray-400' }) %>
                            <span class="font-medium"><%= entrega.municipio.nombre %></span>
                            <span class="text-gray-500">-</span>
                            <span class="text-gray-600">
                              <%= new Date(entrega.fechaHoraEntrega).toLocaleString('es-ES', {
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                              }) %>
                            </span>
                          </li>
                        <% }); %>
                      </ul>
                    </div>
                  </details>
                <% } else { %>
                  <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    <%- include('../partials/icon', { name: 'exclamation-triangle', class: 'h-4 w-4' }) %>
                    Sin entregas
                  </span>
                <% } %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <a 
                  href="/tareas/detalle/<%= tarea.id %>" 
                  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
                >
                  <%- include('../partials/icon', { name: 'eye', class: 'h-4 w-4' }) %>
                  <span>Ver Detalle</span>
                </a>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    
    <!-- Mobile Cards -->
    <div class="md:hidden space-y-4">
      <% tareas.forEach(tarea => { %>
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-2 flex-1">
              <%- include('../partials/icon', { name: 'document-text', class: 'h-5 w-5 text-gray-400 flex-shrink-0' }) %>
              <h3 class="font-medium text-gray-900"><%= tarea.nombre %></h3>
            </div>
          </div>
          
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <%- include('../partials/icon', { name: 'building-office', class: 'h-4 w-4 text-gray-400' }) %>
              <span class="text-gray-600">División:</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <%= tarea.division.nombre %>
              </span>
            </div>
            
            <div class="flex items-center gap-2">
              <%- include('../partials/icon', { name: 'calendar', class: 'h-4 w-4 text-gray-400' }) %>
              <span class="text-gray-600">Inicio:</span>
              <span class="text-gray-900"><%= new Date(tarea.fechaInicio).toLocaleDateString('es-ES') %></span>
            </div>
            
            <div class="flex items-center gap-2">
              <%- include('../partials/icon', { name: 'calendar', class: 'h-4 w-4 text-gray-400' }) %>
              <span class="text-gray-600">Culminación:</span>
              <span class="text-gray-900"><%= new Date(tarea.fechaCulminacion).toLocaleDateString('es-ES') %></span>
            </div>
            
            <div class="pt-2 border-t border-gray-200">
              <% if (tarea.entregas && tarea.entregas.length > 0) { %>
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <%- include('../partials/icon', { name: 'check-circle', class: 'h-4 w-4' }) %>
                      <%= tarea.entregas.length %> entrega<%= tarea.entregas.length !== 1 ? 's' : '' %>
                    </span>
                  </summary>
                  <div class="mt-2 p-3 bg-gray-50 rounded-lg">
                    <ul class="space-y-1">
                      <% tarea.entregas.forEach(entrega => { %>
                        <li class="text-sm text-gray-700">
                          <div class="flex items-center gap-2">
                            <%- include('../partials/icon', { name: 'map-pin', class: 'h-4 w-4 text-gray-400' }) %>
                            <span class="font-medium"><%= entrega.municipio.nombre %></span>
                          </div>
                          <div class="ml-6 text-gray-600">
                            <%= new Date(entrega.fechaHoraEntrega).toLocaleString('es-ES', {
                              month: '2-digit',
                              day: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit'
                            }) %>
                          </div>
                        </li>
                      <% }); %>
                    </ul>
                  </div>
                </details>
              <% } else { %>
                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  <%- include('../partials/icon', { name: 'exclamation-triangle', class: 'h-4 w-4' }) %>
                  Sin entregas
                </span>
              <% } %>
            </div>
          </div>
          
          <div class="mt-3 pt-3 border-t border-gray-200">
            <a 
              href="/tareas/detalle/<%= tarea.id %>" 
              class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 w-full justify-center"
            >
              <%- include('../partials/icon', { name: 'eye', class: 'h-4 w-4' }) %>
              <span>Ver Detalle</span>
            </a>
          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
</div>
